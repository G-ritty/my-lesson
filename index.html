<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®¾è®¡æˆ‘çš„ç¬¬ä¸€å¼ ç”µå­è´ºå¡ - æ™ºèƒ½å¯¼å­¦æ¡ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --p-color: #FF9F43; --s-color: #54a0ff; --a-color: #ff6b6b; --bg: #feca57; }
        body { font-family: "Microsoft YaHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* å¯¼å­¦æ¡ˆå®¹å™¨ */
        .main-container { 
            max-width: 800px; margin: 0 auto; background: white; padding: 30px; 
            border-radius: 20px; border: 5px dashed var(--s-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* å…³å¡å¡ç‰‡ - å¢åŠ åˆ†é¡µä¿æŠ¤ï¼Œè§£å†³PDFæˆªæ–­ */
        .level-card { 
            border: 2px solid #f9f9f9; border-radius: 15px; padding: 20px; 
            margin-bottom: 25px; background: #fff;
            page-break-inside: avoid; /* æ ¸å¿ƒï¼šé˜²æ­¢PDFç”Ÿæˆæ—¶åœ¨æ­¤æ–­å¼€ */
            break-inside: avoid;
        }

        .level-header { background: var(--a-color); color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; font-weight: bold; margin-bottom: 10px; }
        canvas { border: 2px dashed #ccc; width: 100%; height: 150px; cursor: crosshair; background: #fff; margin-top: 10px; border-radius: 10px; }
        
        /* æ™ºèƒ½ä½“æ‚¬æµ®çª—å£ */
        #ai-chat-box { 
            position: fixed; bottom: 100px; right: 30px; width: 320px; height: 450px; 
            background: white; border-radius: 15px; box-shadow: 0 5px 30px rgba(0,0,0,0.2); 
            display: none; flex-direction: column; z-index: 2000; border: 2px solid var(--s-color);
        }
        .chat-top { background: var(--s-color); color: white; padding: 12px; border-radius: 13px 13px 0 0; display: flex; justify-content: space-between; font-weight: bold; }
        .chat-content { flex: 1; padding: 15px; overflow-y: auto; background: #fdfdfd; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 14px; line-height: 1.5; max-width: 85%; }
        .ai-msg { background: #eee; align-self: flex-start; border-bottom-left-radius: 2px; }
        .user-msg { background: var(--s-color); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

        /* å³ä¸‹è§’æŒ‰é’®ç»„ */
        .fab-group { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 15px; z-index: 2001; }
        .btn-round { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: 0.3s; }
        .btn-round:hover { transform: translateY(-5px); }
        .btn-ai { background: var(--s-color); }
        .btn-export { background: var(--a-color); font-size: 14px; font-weight: bold; }

        /* PDF å¯¼å‡ºä¸“ç”¨å¯¹è¯è®°å½•åŒº */
        #chat-pdf-area { display: none; border-top: 2px dashed #ddd; margin-top: 30px; padding-top: 20px; }
        .no-print { display: block; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

    <div class="fab-group no-print">
        <button class="btn-round btn-ai" onclick="toggleChat()">ğŸ¤–</button>
        <button class="btn-round btn-export" onclick="exportPDF()">å¯¼å‡º<br>PDF</button>
    </div>

    <div id="ai-chat-box">
        <div class="chat-top"><span>ğŸ¤– æ™ºèƒ½åŠ©æ•™å°é€š</span><span style="cursor:pointer" onclick="toggleChat()">âœ–</span></div>
        <div class="chat-content" id="chat-content">
            <div class="msg ai-msg">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„è®¾è®¡åŠ©æ‰‹ã€‚åœ¨åˆ¶ä½œè´ºå¡æ—¶é‡åˆ°é—®é¢˜ï¼Œæ¯”å¦‚â€œæ€ä¹ˆæ”¹é¢œè‰²â€ï¼Œéšæ—¶é—®æˆ‘ï¼</div>
        </div>
        <div style="padding: 10px; display: flex; gap: 5px; border-top: 1px solid #eee;">
            <input type="text" id="chat-input" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:20px;" placeholder="åœ¨æ­¤è¾“å…¥é—®é¢˜..." onkeypress="if(event.keyCode==13) sendToAI()">
            <button onclick="sendToAI()" style="background:var(--p-color); border:none; color:white; border-radius:15px; padding:0 12px; cursor:pointer;">å‘é€</button>
        </div>
    </div>

    <div class="main-container" id="worksheet">
        <h1 style="text-align: center; color: var(--a-color);">ğŸ¨ è®¾è®¡æˆ‘çš„ç¬¬ä¸€å¼ ç”µå­è´ºå¡ ğŸ¨</h1>
        <p style="text-align: center; color: #666;">ï¼ˆå°å­¦ä¿¡æ¯æŠ€æœ¯è¯¾ç¨‹å¯¼å­¦æ¡ˆï¼‰</p>

        <div class="level-card">
            <div class="level-header">ç¬¬ä¸€å…³ï¼šæ‰“å¼€å®ç®±</div>
            <p>ä»»åŠ¡ï¼šå¯åŠ¨ WPSæ–‡å­— æˆ– Wordã€‚å¹¶åœ¨ä¸‹æ–¹ç”»å‡ºä½ è®¤è¯†çš„å·¥å…·å›¾æ ‡ï¼ˆå¦‚ï¼šä¿å­˜ã€å­—ä½“ï¼‰ï¼š</p>
            <canvas id="draw-canvas"></canvas>
            <button class="no-print" onclick="clearCanvas()" style="margin-top:10px; cursor:pointer;">æ¸…ç©ºç”»å¸ƒ</button>
        </div>

        <div class="level-card">
            <div class="level-header">ç¬¬äºŒå…³ï¼šè¾“å…¥é­”æ³•å’’è¯­</div>
            <p>ä»»åŠ¡ï¼šè¾“å…¥ä½ çš„ç¥ç¦è¯­ï¼ˆä¾‹å¦‚ï¼šç¥è€å¸ˆèŠ‚æ—¥å¿«ä¹ï¼ï¼‰ï¼Œå¹¶å°è¯•ç¾åŒ–å®ƒã€‚</p>
            <textarea style="width:100%; height:80px; border-radius:10px; padding:10px; border:1px solid #ddd;" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ç¥ç¦å†…å®¹..."></textarea>
        </div>

        <div class="level-card">
            <div class="level-header">ç¬¬ä¸‰å…³ï¼šæ’å…¥è£…æ‰®</div>
            <p>ä»»åŠ¡ï¼šä¸ºè´ºå¡æ·»åŠ èƒŒæ™¯å›¾ã€‚è¯·ä¸Šä¼ ä½ çš„ä½œå“æˆªå›¾ï¼š</p>
            <input type="file" class="no-print" onchange="previewFile(event)">
            <img id="preview-img" style="max-width:100%; display:none; margin-top:15px; border-radius:10px; border:1px solid #eee;">
        </div>

        <div id="chat-pdf-area">
            <h3 style="color: var(--s-color);">ğŸ’¬ æˆ‘ä¸ AI åŠ©æ•™çš„å¯¹è¯è®°å½•ï¼š</h3>
            <div id="chat-log-list"></div>
        </div>
    </div>

    <script>
        // ======= 1. æ ¸å¿ƒé…ç½®åŒº =======
        const AI_CONFIG = {
            key: 'sk-56abaf7300b54705853cba2b1365aeed', // <--- è¯·åŠ¡å¿…ä¿®æ”¹æ­¤å¤„
            appId: 'b02ae061efb14b1fb62db5fc6792bccd', // å·²åŒ¹é…æ‚¨çš„æˆªå›¾ ID
            endpoint: 'https://dashscope.aliyuncs.com/api/v1/apps'
        };

        // ======= 2. æ™ºèƒ½ä½“äº¤äº’é€»è¾‘ =======
        let chatHistory = [];
        function toggleChat() {
            const box = document.getElementById('ai-chat-box');
            box.style.display = box.style.display === 'flex' ? 'none' : 'flex';
        }

        async function sendToAI() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            addBubble('user-msg', text);
            input.value = '';

            if(AI_CONFIG.key.includes('æ‚¨çš„çœŸå®')) {
                addBubble('ai-msg', 'âš ï¸ è¯·åœ¨ä»£ç ç¬¬ 170 è¡Œé…ç½®æ‚¨çš„ API Keyã€‚');
                return;
            }

            try {
                // æ„å»ºé’ˆå¯¹æ‚¨ AppID çš„ä¸“ç”¨ URL
                const apiUrl = `${AI_CONFIG.endpoint}/${AI_CONFIG.appId}/completion`;
                
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AI_CONFIG.key}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        "input": { "prompt": text },
                        "parameters": { "incremental_output": false }
                    })
                });

                const data = await res.json();
                if(data.output && data.output.text) {
                    addBubble('ai-msg', data.output.text);
                } else {
                    addBubble('ai-msg', 'æŠ±æ­‰ï¼Œè¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                addBubble('ai-msg', 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¡®ä¿åœ¨ GitHub HTTPS ç¯å¢ƒä¸‹è®¿é—®ã€‚');
            }
        }

        function addBubble(cls, txt) {
            const box = document.getElementById('chat-content');
            const div = document.createElement('div');
            div.className = `msg ${cls}`;
            div.innerText = txt;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            chatHistory.push({ role: cls === 'user-msg' ? 'å­¦ç”Ÿ' : 'åŠ©æ•™', content: txt });
        }

        // ======= 3. PDF å¯¼å‡ºé€»è¾‘ =======
        function exportPDF() {
            const element = document.getElementById('worksheet');
            const logArea = document.getElementById('chat-pdf-area');
            const logList = document.getElementById('chat-log-list');

            // å¡«å……è®°å½•
            if(chatHistory.length > 0) {
                logList.innerHTML = chatHistory.map(h => `<p><strong>${h.role}:</strong> ${h.content}</p>`).join('');
                logArea.style.display = 'block';
            }

            window.scrollTo(0,0); // å›åˆ°é¡¶éƒ¨é˜²æ­¢åç§»

            const opt = {
                margin: 10,
                filename: 'æˆ‘çš„ç”µå­è´ºå¡å­¦ä¹ å•.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                logArea.style.display = 'none';
            });
        }

        // ======= 4. ç”»æ¿ä¸æ–‡ä»¶åŠŸèƒ½ =======
        const canvas = document.getElementById('draw-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        canvas.addEventListener('mousedown', () => { isDrawing = true; ctx.beginPath(); });
        canvas.addEventListener('mousemove', (e) => {
            if(!isDrawing) return;
            const r = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
            ctx.stroke();
        });
        window.addEventListener('mouseup', () => isDrawing = false);
        function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); }
        function previewFile(e) {
            const img = document.getElementById('preview-img');
            img.src = URL.createObjectURL(e.target.files[0]);
            img.style.display = 'block';
        }
    </script>
</body>
</html>